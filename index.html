<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Dil Se Songbook</title>
  <style>
    :root{
      --bg:#ffffff;
      --fg:#111111;
      --muted:#666;
      --card:#f7f7f7;
      --border:#e2e2e2;
      --accent:#2f6fed;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    body.dark{
      --bg:#0f1115;
      --fg:#f2f2f2;
      --muted:#a7a7a7;
      --card:#171a21;
      --border:#2a2f3a;
      --accent:#6aa6ff;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Arial, Helvetica, sans-serif;
      background:var(--bg);
      color:var(--fg);
    }
    .topbar{
      width:100%;
      height:8px;
      background:#0b7a78;
    }
    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 22px 16px 40px;
    }
    h1{
      text-align:center;
      margin: 10px 0 18px;
      font-size: 44px;
      letter-spacing: .5px;
    }

    .panel{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding: 14px;
      margin: 14px auto;
    }

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 10px;
    }

    select{
      width:100%;
      padding: 14px 14px;
      font-size: 22px;
      border-radius: 12px;
      border:2px solid var(--accent);
      background: var(--bg);
      color: var(--fg);
      outline:none;
    }

    .btn{
      padding:10px 14px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: var(--bg);
      color: var(--fg);
      cursor:pointer;
      font-size:16px;
    }
    .btn.primary{
      border-color: transparent;
      background: var(--accent);
      color: #fff;
    }

    .control{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      width:100%;
    }

    .label{
      font-size: 14px;
      color: var(--muted);
      min-width: 70px;
    }

    input[type="range"]{
      width: 220px;
    }

    .tip{
      text-align:center;
      color: var(--muted);
      font-size: 14px;
      margin-top: 6px;
    }

    .error{
      text-align:center;
      color: #d11;
      font-size: 14px;
      margin-top: 8px;
    }

    .songbox{
      background: var(--bg);
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
      overflow:auto;
      max-height: 62vh;
    }

    pre{
      margin:0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space: pre;      /* keep exact line breaks + spacing */
      line-height: 1.45;
    }
    pre.wrap{
      white-space: pre-wrap;  /* wrap lines but still keep line breaks */
      word-break: break-word;
    }

    @media (max-width: 700px){
      h1{ font-size: 34px; }
      select{ font-size: 18px; }
      input[type="range"]{ width: 180px; }
    }
  </style>
</head>
<body>
  <div class="topbar"></div>

  <div class="wrap">
    <h1>Dil Se Songbook</h1>

    <div class="panel">
      <select id="songSelect">
        <option value="">loading setlist…</option>
      </select>

      <div class="row" style="margin-top:12px;">
        <button class="btn" id="darkBtn">dark mode</button>
        <button class="btn" id="wrapBtn">wrap lines</button>
        <button class="btn primary" id="scrollBtn">auto-scroll: off</button>
      </div>

      <div class="row">
  <div class="control">
    <div class="label">font size</div>
    <input id="fontRange" type="range" min="14" max="34" value="20" />
    <div id="fontVal" class="label" style="min-width:40px;">20px</div>
  </div>

  <div class="control" style="justify-content:flex-end;">
    <div class="label">transpose</div>
    <select id="transposeSelect" style="width:auto; min-width:130px; padding:10px 12px; font-size:16px; border:1px solid var(--border);">
      <option value="0">0</option>
      <option value="-1">-1</option>
      <option value="-2">-2</option>
      <option value="-3">-3</option>
      <option value="-4">-4</option>
      <option value="-5">-5</option>
      <option value="-6">-6</option>
      <option value="-7">-7</option>
      <option value="-8">-8</option>
      <option value="-9">-9</option>
      <option value="-10">-10</option>
      <option value="-11">-11</option>
      <option value="1">+1</option>
      <option value="2">+2</option>
      <option value="3">+3</option>
      <option value="4">+4</option>
      <option value="5">+5</option>
      <option value="6">+6</option>
      <option value="7">+7</option>
      <option value="8">+8</option>
      <option value="9">+9</option>
      <option value="10">+10</option>
      <option value="11">+11</option>
    </select>

    <div class="label" style="margin-left:10px;">scroll speed</div>
    <input id="speedRange" type="range" min="1" max="60" value="20" />
    <div id="speedVal" class="label" style="min-width:40px;">20</div>
  </div>
</div>

      <div class="tip">tip: if a line is long, swipe sideways inside the song box (or turn on “wrap lines”).</div>
      <div id="err" class="error"></div>
    </div>

    <div class="panel">
      <div class="songbox" id="songBox">
        <pre id="songPre">pick a song above…</pre>
      </div>
      <div class="tip">stage tip: set font size bigger + turn on auto-scroll.</div>
    </div>
  </div>

  <script>
    // Fixes GitHub Pages "project site" path issues.
    // Example:
    //   https://username.github.io/repo-name/  -> base is /repo-name/
    //   https://username.github.io/repo-name/index.html -> base is /repo-name/
    const basePath = (() => {
      const p = window.location.pathname;
      return p.endsWith("/") ? p : p.replace(/\/[^\/]*$/, "/");
    })();

    const url = (relative) => `${basePath}${relative.replace(/^\//, "")}`;

    const songSelect = document.getElementById("songSelect");
    const songPre = document.getElementById("songPre");
    const songBox = document.getElementById("songBox");
    const err = document.getElementById("err");

    const darkBtn = document.getElementById("darkBtn");
    const wrapBtn = document.getElementById("wrapBtn");
    const scrollBtn = document.getElementById("scrollBtn");

    const fontRange = document.getElementById("fontRange");
    const fontVal = document.getElementById("fontVal");
    const speedRange = document.getElementById("speedRange");
    const speedVal = document.getElementById("speedVal");
    const transposeSelect = document.getElementById("transposeSelect");
    let currentSongText = ""; // stores the original song text

    let transposeSteps = 0;

function renderSong(){
  const semis = transposeSteps || 0;
  const out = applyTransposeToText(currentSongText || "", semis);
  songPre.textContent = out || "pick a song above…";
}
 // --- transpose engine (step 2) ---
const SHARP_NOTES = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const FLAT_NOTES  = ["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"];

function toIndex(note){
  const n = note.replace("♯","#").replace("♭","b");
  let i = SHARP_NOTES.indexOf(n);
  if (i !== -1) return i;
  i = FLAT_NOTES.indexOf(n);
  return i;
}

function fromIndex(i, preferFlats){
  const arr = preferFlats ? FLAT_NOTES : SHARP_NOTES;
  return arr[(i + 1200) % 12];
}

function transposeChordToken(token, semis){
  // handle slash chords like D/F#
  const parts = token.split("/");
  const main = transposeOne(parts[0], semis);
  if (!main) return token;

  if (parts.length === 2){
    const bass = transposeOne(parts[1], semis);
    return main + "/" + (bass || parts[1]);
  }
  return main;
}

function transposeOne(chord, semis){
  // root: A-G + optional #/b, rest stays the same (m, maj7, sus4, 7, etc.)
  const m = chord.match(/^([A-G])([#b]?)(.*)$/);
  if (!m) return null;

  const root = m[1] + (m[2] || "");
  const rest = m[3] || "";

  // small guard: avoid changing words that start with A-G but aren’t chords
  // allow common chord suffix patterns
  const chordish = rest === "" || /^[mM]|^(maj|min|sus|add|dim|aug)|^\d/.test(rest);
  if (!chordish) return null;

  const idx = toIndex(root);
  if (idx === -1) return null;

  const preferFlats = root.includes("b");
  const newRoot = fromIndex(idx + semis, preferFlats);
  return newRoot + rest;
}

function applyTransposeToText(text, semis){
  if (!semis) return text;

  // Replace chord tokens but keep spacing exactly (important for your formatting)
  return text.replace(/\S+/g, (tok) => {
    // strip common punctuation around tokens
    const m = tok.match(/^([(\["'`{<]*)(.*?)([)\]"'`}>.,;:!?]*)$/);
    if (!m) return tok;

    const lead = m[1];
    const core = m[2];
    const tail = m[3];

    const t = transposeChordToken(core, semis);
    return lead + t + tail;
  });
}

    let setlist = [];
    let autoScrollOn = false;
    let scrollTimer = null;

    function setError(msg){
      err.textContent = msg || "";
    }

    function setFont(px){
      songPre.style.fontSize = px + "px";
      fontVal.textContent = px + "px";
    }

    function setSpeed(v){
      speedVal.textContent = String(v);
    }

    function stopAutoScroll(){
      autoScrollOn = false;
      scrollBtn.textContent = "auto-scroll: off";
      if (scrollTimer) {
        clearInterval(scrollTimer);
        scrollTimer = null;
      }
    }

    function startAutoScroll(){
      autoScrollOn = true;
      scrollBtn.textContent = "auto-scroll: on";
      if (scrollTimer) clearInterval(scrollTimer);

      scrollTimer = setInterval(() => {
        const speed = Number(speedRange.value); // 1..60
        songBox.scrollTop += speed * 0.5; // tune feel
        if (songBox.scrollTop + songBox.clientHeight >= songBox.scrollHeight - 2) {
          // reached bottom, stop
          stopAutoScroll();
        }
      }, 120);
    }

    async function loadSetlist(){
      setError("");
      songSelect.innerHTML = `<option value="">loading setlist…</option>`;

      try {
        const res = await fetch(url(`setlist.json?v=${Date.now()}`), { cache: "no-store" });
        if (!res.ok) throw new Error(`setlist.json not found (HTTP ${res.status})`);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error("setlist.json is not an array");

        setlist = data;

        songSelect.innerHTML = `<option value="">select a song…</option>` + setlist.map((s, i) => {
          const name = (s && s.name) ? String(s.name) : `Song ${i+1}`;
          return `<option value="${i}">${escapeHtml(name)}</option>`;
        }).join("");

      } catch (e) {
        songSelect.innerHTML = `<option value="">setlist load failed</option>`;
        setError(`could not load setlist.json. confirm it is in repo root. details: ${e.message}`);
      }
    }

    async function loadSongByIndex(idx){
      stopAutoScroll();
      setError("");

      const item = setlist[idx];
      if (!item || !item.file) {
        songPre.textContent = "pick a song above…";
        return;
      }

      try {
        const res = await fetch(url(`${item.file}?v=${Date.now()}`), { cache: "no-store" });
        if (!res.ok) throw new Error(`song file not found (HTTP ${res.status})`);
        const text = await res.text();
        currentSongText = text || "";
        renderSong();
        songBox.scrollTop = 0;
      } catch (e) {
        songPre.textContent = "error loading song file.";
        setError(`could not load ${item.file}. details: ${e.message}`);
      }
    }

    function escapeHtml(str){
      return str
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // UI events
    songSelect.addEventListener("change", () => {
      const v = songSelect.value;
      if (v === "") {
        songPre.textContent = "pick a song above…";
        return;
      }
      loadSongByIndex(Number(v));
    });

    darkBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark");
    });

    wrapBtn.addEventListener("click", () => {
      songPre.classList.toggle("wrap");
    });

    scrollBtn.addEventListener("click", () => {
      if (autoScrollOn) stopAutoScroll();
      else startAutoScroll();
    });

    fontRange.addEventListener("input", () => setFont(Number(fontRange.value)));
    speedRange.addEventListener("input", () => setSpeed(Number(speedRange.value)));

transposeSelect.addEventListener("change", () => {
  stopAutoScroll();
  transposeSteps = Number(transposeSelect.value) || 0;
  renderSong();
});

    // init
    setFont(Number(fontRange.value));
    setSpeed(Number(speedRange.value));
    loadSetlist();
  </script>
</body>
</html>
